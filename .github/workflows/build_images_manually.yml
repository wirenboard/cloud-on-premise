name: Build all on-premise images

on:
  workflow_dispatch:
    inputs:
      REGISTRY:
        description: "Registry"
        type: choice
        required: true
        default: ghcr.io
        options:
          - ghcr.io
          - registry.wirenboard.com
      TARGET:
        description: "Target"
        required: true
        type: choice
        default: release
        options:
          - release
          - testing
      REF:
        description: "Branch name to build from"
        required: false
        type: string

jobs:
  read_version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - id: read_version
        shell: bash
        run: |
          VERSION=$(cat VERSION | tr -d '\r' | xargs)
          if [[ -z "$VERSION" ]]; then
            echo "Error: version file is empty"; exit 1
          fi
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: invalid version format, must be X.Y.Z"; exit 1
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"
    outputs:
      image_version: ${{ steps.read_version.outputs.VERSION }}

  dispatch-all:
    needs: read_version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repository: [
          cloud-backend,
          cloud-frontend,
          cloud-tunnel,
          cloud-webssh
        ]
    steps:
      - name: Dispatch to ${{ matrix.repository }}
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GHCR_TOKEN }}
          repository: "wirenboard/${{ matrix.repository }}"
          event-type: build-on-premise
          client-payload: >-
            {
              "REGISTRY": "${{ inputs.REGISTRY }}",
              "TARGET": "${{ inputs.TARGET }}",
              "IMAGE_VERSION": "${{ needs.read_version.outputs.image_version }}",
              "GROUP": "on-premise",
              "REF": "${{ inputs.REF || github.ref_name }}"
            }
